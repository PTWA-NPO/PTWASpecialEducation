<template>
  <div class="fraction-for-answer" ref="container">
    <input
      ref="numerator"
      class="fraction-input numerator"
      type="text"
      @click="showNumPad('numerator', $event)"
    />
    <span class="line"></span>
    <input
      ref="denominator"
      class="fraction-input denominator"
      type="text"
      @click="showNumPad('denominator', $event)"
    />
  </div>
  <FloatNumPad
    v-if="virtualNumpadSwitch"
    :Data="numPadPosition"
    @button-clicked="numPadButtonClicked"
  />
</template>

<script>
import { defineAsyncComponent } from "vue";

export default {
  name: "FractionForAnswer",
  props: {
    Data: {
      type: Object,
      required: true,
    },
  },
  emits: ["validation"],
  components: {
    FloatNumPad: defineAsyncComponent(() =>
      import("@/components/FloatNumPad.vue")
    ),
  },
  data() {
    return {
      virtualNumpadSwitch: false,
      numPadPosition: {
        top: 0,
        left: 0,
      },
      activeInputRef: "",
      // 定義常數
      numPadOffset: 10, // 虛擬鍵盤與目標輸入框的間距
    };
  },
  methods: {
    showNumPad(inputRef, event) {
      const inputRect = event.target.getBoundingClientRect();

      this.activeInputRef = inputRef;

      this.numPadPosition = {
        top: `${inputRect.bottom + window.scrollY + this.numPadOffset}px`,
        left: `${inputRect.left + window.scrollX}px`,
      };

      this.virtualNumpadSwitch = true;
    },
    numPadButtonClicked(label) {
      switch (label) {
        case "清除":
          this.clearActiveInput();
          break;
        case "關閉":
          this.closeNumPad();
          break;
        default:
          this.updateInputValue(label);
          this.validateAnswer();
          break;
      }
    },
    validateAnswer() {
      const userNumerator = this.$refs.numerator.value;
      const userDenominator = this.$refs.denominator.value;

      const isCorrect =
        parseInt(userNumerator, 10) === this.Data.numerator &&
        parseInt(userDenominator, 10) === this.Data.denominator;

      this.$emit("validation", isCorrect);
    },
    closeNumPad() {
      this.virtualNumpadSwitch = false;
    },
    clearActiveInput() {
      if (this.activeInputRef) {
        this.$refs[this.activeInputRef].value = "";
      }
    },
    updateInputValue(label) {
      if (this.activeInputRef) {
        const input = this.$refs[this.activeInputRef];
        input.value += label;
      }
    },
  },
};
</script>

<style scoped>
.fraction-for-answer {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  text-align: center;
  height: 100%;
  width: 100%;
  gap: 0.2rem;
}

.fraction-input {
  flex: 1;
  width: 100%;
  text-align: center;
  font-size: 1.5rem;
}

.line {
  display: block;
  border-top: 0.2rem solid black;
  width: 100%;
  margin: 2px 0;
}
</style>
